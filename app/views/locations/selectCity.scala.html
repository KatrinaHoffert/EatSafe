@import general._
@import models._
@import controllers._
@import play.api.libs.json.Json

@**
 * Allows a user to select their city of interest from a list of municipalities in their
 * current region.
 *
 * @param municipalities A list of all the municipalities the user may choose from.
 *@
@(municipalities: Seq[String])

@scripts = {
  <script src="@controllers.routes.Assets.at("javascripts/common.js")"></script>
  <script src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
  <script>
    "use strict";
 	// Create fake console if one doesn't exist
	// For compatibility with packages not including console object
	if ( typeof ( console ) !== 'undefined' && console != null) {
	  console.log("");
	}
	else {
	  console = {
		log: function () {},
		warn: function () {},
		error: function () {}
	  }
	}
    
    var cities = @Html(Json.toJson(municipalities).toString);
    var selectedCity;
    
    $("#municipality").typeahead({
      delay: 100,
      minLength: 1,
      maxItem: 8,
      hint: true,
      source: {
        data: cities
      },
      callback: {
        onSubmit: function(node, form, obj, e) {
          var municipalityFieldValue = $("#municipality").val();
          
          if(obj == null) {
            if(municipalityFieldValue == "") {
              createPageError("@Messages("locations.selectLocation.noInput")");
              return;
            } else {
              window.location.assign(jsRoutes.controllers.LocationController.findLocation(municipalityFieldValue).url);
            }
          } else {
            window.location.assign(jsRoutes.controllers.LocationController.findLocation(obj.display).url);
          }
        
        
          if($("#municipality").val() == "") {
            
          } else if(obj == null) {
            if ($("#municipality").val() == "") {
              createPageError("@Messages("locations.selectLocation.badInput")");
              return;
            } else {
              selectedCity = $("#municipality").val();
            }
          } else {
		        selectedCity = obj.display;
		      }
          	console.log(selectedCity);
        }
      }
    });
    $("#municipality").focus();
  </script>
  <script>
    if (navigator.geolocation) {
      // Get the current lcoation of the user and pass it to the
      // function we wrote to fill in the typeahead.
      navigator.geolocation.getCurrentPosition(populateField);
    }
    
    var geoSet = false;
    
    var municipality;
    
    // Made to populate the typeahead with a city name.
    // 
    // position: An object with coordinates from navigator.geolocation
    function populateField(position) {
      var lat = position.coords.latitude;
      var long = position.coords.longitude;
      
      var geocoder = new google.maps.Geocoder();
      var latLong = new google.maps.LatLng(lat, long);
      
      // Pass the lat/long combination to Google's Geocode API
      geocoder.geocode({'latLng': latLong}, function (results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          
          // A result has many components of many types, so we need
          // to traverse through them to get what we want.
          for (var i = 0; i < results[0].address_components.length; i++) {
            for (var j = 0; j < results[0].address_components[i].types.length; j++) {
            
              // In Canada the result we need is usually tagged
              // "locality". See API docs for more info.
              if (results[0].address_components[i].types[j] == "locality") {
                municipality = results[0].address_components[i];
                
                // Not elegant, but easier than the alternatives.
                break;
              }
            }
          }
          
          // Set the search field to the current municipality.
          $("#municipality").val(municipality.long_name);
          geoSet = true;
          $("#reset-button").show();
          console.log("Got " + municipality.long_name);
        } else {
          	console.log(status);
        }
      })
    }
    
    function clearFieldIfGeolocated() {
      if(geoSet == true) {
        $("#municipality").val("");
        $("#reset-button").hide();
        geoSet = false;
      }
    }
  </script>
}

@mainBody(title = Messages("locations.selectCity.title"), moreScripts = scripts) {
  @headingLarge(Messages("general.applicationName"))
  <div class="smallPadding">
    <h2>@Messages("locations.selectCity.prompt")</h2>

    <form id="form-municipality">
      <div class="typeahead-container">
        <div class="typeahead-field">
          <span class="typeahead-query">
            <input id="municipality" type="search" placeholder="Search" autocomplete="off">
          </span>
          <span class="glyphicon glyphicon-remove-sign btn-lg" onclick="clearFieldIfGeolocated()" id="reset-button"></span>
          <span class="typeahead-button">
            <button type="submit" id="submitButton">
              <i class="search-icon"></i>
            </button>
          </span>
          <span class="glyphicon glyphicon-map-marker btn-lg" width="32" onclick="if(navigator.geolocation){navigator.geolocation.getCurrentPosition(populateField);}"></span>
        </div>
      </div>
    </form>
  </div>
}
